# syntax=docker/dockerfile:experimental
FROM public.ecr.aws/lambda/python:latest

# install packages
RUN yum update -y
RUN yum install -y git

# install requirements
RUN pip3 install gunicorn
RUN mkdir -p -m 0600 ~/.ssh
RUN ssh-keyscan github.com >> ~/.ssh/known_hosts

# Entry
RUN printf "#!/bin/bash\n \
    \nif [[ -z \"\${PORT}\" ]]; then  \
    \nsource /lambda-entrypoint.sh \"\$@\" \
    \nelse \
    \necho \"Running on port \$PORT\" \
    \ngunicorn --worker-tmp-dir /dev/shm --workers \$(( 2 * \`cat /proc/cpuinfo | grep 'core id' | wc -l\` )) --bind 0.0.0.0:\$PORT main:app  \    
    \nfi\n"  > /var/task/init.sh
RUN chmod +x /var/task/init.sh
ENTRYPOINT ["/var/task/init.sh" ]

# Default supply if lambda
CMD [ "main.handler" ]